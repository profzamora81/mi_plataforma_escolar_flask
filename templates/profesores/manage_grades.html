{# templates/profesores/manage_grades.html #}
{% extends "base.html" %}

{% block content %}
    <h1>Gestionar Notas para {{ subject.name }}</h1>
    <h2>Estudiantes Inscritos y Notas</h2>

    {# Mensaje informativo para el profesor #}
    <div class="alert alert-info" role="alert">
        <strong>Importante:</strong> Los cambios o eliminaciones de notas deben ser solicitados a un Administrador. Haz clic en "Solicitar Cambio" junto a la nota para enviar tu petición.
    </div>

    {% if enrolled_students %}
        <table border="1" style="width:100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background-color:#f2f2f2;">
                    <th style="padding: 8px; text-align: left;">Estudiante</th>
                    {# Encabezados para cada actividad configurada #}
                    {% for config in configured_activities %}
                        <th style="padding: 8px; text-align: center;">{{ config.activity_name }} ({{ config.unit_number }}) - {{ config.max_score }}pts</th>
                    {% endfor %}
                    <th style="padding: 8px; text-align: center;">Parciales</th> {# Columna para parciales #}
                    <th style="padding: 8px; text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for student in enrolled_students %}
                    <tr>
                        <td style="padding: 8px;">{{ student.first_name }} {{ student.last_name }}</td>
                        {# Mostrar notas de actividades de zona #}
                        {% for config in configured_activities %}
                            <td style="padding: 8px; text-align: center;">
                                {% set grade = grades_data[student.id][config.id] %}
                                {% if grade %}
                                    {{ grade.value }} 
                                    <br>
                                    <a href="{{ url_for('teacher_request_grade_change', subject_id=subject.id, student_id=student.id, grade_id=grade.id) }}" style="font-size: 0.8em;">Solicitar Cambio</a>
                                {% else %}
                                    N/A <br>
                                    {# Opción para añadir una nota inicial (ej. un 0) si no existe, luego se puede editar #}
                                    {# Esto es un poco más complejo si queremos una solicitud para "añadir" una nueva nota #}
                                    {# Por ahora, el profesor tendría que ir a una ruta de "añadir" (que no existe aún en la nueva lógica) #}
                                    {# o insertar con init_db o similar, y luego solicitar edición #}
                                {% endif %}
                            </td>
                        {% endfor %}
                        
                        {# Mostrar notas de parciales #}
                        <td style="padding: 8px; text-align: center;">
                            {% if grades_data[student.id]['parciales'] %}
                                {% for parcial_grade in grades_data[student.id]['parciales'] %}
                                    {{ parcial_grade.activity_name }}: {{ parcial_grade.value }}
                                    <a href="{{ url_for('teacher_request_grade_change', subject_id=subject.id, student_id=student.id, grade_id=parcial_grade.id) }}" style="font-size: 0.8em;">Solicitar Cambio</a>
                                    <br>
                                {% endfor %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>

                        <td style="padding: 8px; text-align: center;">
                            {# Aquí podrías poner una opción general para "añadir nota", si se implementa una ruta específica para eso #}
                            {# O simplemente el profesor usa la interfaz de arriba para hacer clic en "N/A" y solicitar una nota #}
                            <a href="{{ url_for('teacher_request_grade_change', subject_id=subject.id, student_id=student.id) }}" class="btn btn-sm btn-info">Solicitar Nota (Nueva)</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hay estudiantes inscritos en esta asignatura.</p>
    {% endif %}

    <p style="margin-top: 20px;"><a href="{{ url_for('teacher_dashboard') }}" class="btn btn-secondary">Volver al Dashboard</a></p>
{% endblock %}