{% extends "base.html" %}

{% block content %}
    <h1>Bienvenido, Estudiante {{ estudiante.first_name }} {{ estudiante.last_name }}</h1>

    {% if overall_average_grade > 0 %}
        <p><strong>Tu Promedio General de Notas: {{ "%.2f"|format(overall_average_grade) }}</strong></p>
    {% else %}
        <p>Aún no tienes notas registradas para calcular un promedio general.</p>
    {% endif %}

    <h2>Anuncios Importantes</h2>
    {% if <student_announcements> %} {# Por ejemplo, admin_announcements #}
        <ul>
        {% for announcement in <student_announcements> %}
            <li>
                <h3>{{ announcement.title }}</h3>
                <p>{{ announcement.content }}</p>
                <small>Publicado por: {{ announcement.user.username }} el {{ announcement.date_posted.strftime('%d-%m-%Y %H:%M') }}</small>
                <small>Dirigido a: {{ announcement.target_role }}</small>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No hay anuncios disponibles en este momento.</p>
    {% endif %}

    <h2>Tus Asignaturas con Notas:</h2>

    {% if subjects_data %} {# ¡Esta es la condición que estamos depurando! #}
        <table border="1" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color:#f2f2f2;">
                    <th style="padding: 8px; text-align: left;">Asignatura</th>
                    <th style="padding: 8px; text-align: left;">Código</th>
                    <th style="padding: 8px; text-align: left;">Profesor</th>
                    <th style="padding: 8px; text-align: left;">Promedio de Notas</th>
                    <th style="padding: 8px; text-align: left;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in subjects_data %}
                    <tr>
                        <td style="padding: 8px;">{{ item.subject_obj.name }}</td>
                        <td style="padding: 8px;">{{ item.subject_obj.code }}</td>
                        <td style="padding: 8px;">
                            {% if item.subject_obj.teacher_obj %}
                                {{ item.subject_obj.teacher_obj.first_name }} {{ item.subject_obj.teacher_obj.last_name }}
                            {% else %}
                                Sin Asignar
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            {% if item.average_grade is not none and item.average_grade > 0 %}
                                {{ "%.2f"|format(item.average_grade) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td style="padding: 8px;">
                            <a href="{{ url_for('student_view_grades', subject_id=item.subject_obj.id) }}">Ver Mis Notas</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Aún no tienes notas registradas en ninguna asignatura.</p>
    {% endif %}
{% endblock %}